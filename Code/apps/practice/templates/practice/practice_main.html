{% extends "p4ds/base_layout.html" %}
{% load static %}
{% block body %}
<section class="practice-main">
    <div class="container">
        <!-- Top Section: Key Statistics -->
        <div class="top-section">
            <div class="stats-chart">
                <h3>Key Statistics</h3>
                {% comment %} <canvas id="correctRateChart"></canvas> {% endcomment %}
                <ul class="stats-details">
                    <li>Total problems solved: <span id="total-solved">{{ total_solved }}</span></li>
                    <li>Success rate: <span id="success-rate"></span>{{success_rate}}%</li>
                </ul>
            </div>
            <div class="practice-call-to-action">
                <h4>지금까지 공부한 내용을 바탕으로</h4>
                <p>나를 위한 문제 추천 받기</p>
                <button onclick="window.location.href='/practice/attempt/'" class="btn btn-primary">추천받아 문제 풀기</button>
            </div>
        </div>

        <!-- Bottom Section: Analytics and Practice History -->
        <div class="bottom-section">
            <div class="analytics">
                <h3>Concept Mastery</h3>
                <canvas id="analyticsChart"></canvas>
            </div>
            <div class="practice-history">
                <h3>나의 풀이 기록</h3>
                <table class="practice-table">
                    <thead>
                        <tr>
                            <th>개념 영역</th>
                            <th>풀어본 날짜</th>
                            <th>정답률</th>
                        </tr>
                    </thead>
                    <tbody id="practiceHistoryTable">
                        <!-- Dynamic practice history rows will be inserted here -->
                    </tbody>
                </table>
                <div class="pagination">
                    <button id="prevPage" class="btn" disabled>Previous</button>
                    <button id="nextPage" class="btn">Next</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        fetchPracticeData();
        fetchPracticeHistory();

        // Fetch the main statistics data
        function fetchPracticeData() {
            fetch(`/practice/main/`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('total-solved').textContent = data.data.total_solved;
                        document.getElementById('success-rate').textContent = `${data.data.success_rate}%`;
                        renderCorrectRateChart(data.data.success_rate);
                        renderAnalyticsChart(data.data.analytics_data);
                    } else {
                        console.error('Failed to load practice data:', data.message);
                    }
                })
                .catch(error => console.error('Error loading practice data:', error));
        }

        // Render the correct answer rate chart
        function renderCorrectRateChart(successRate) {
            const ctx = document.getElementById('correctRateChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Incorrect'],
                    datasets: [{
                        data: [successRate, 100 - successRate],
                        backgroundColor: ['#057159', '#ddd']
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Render the concept mastery analytics chart
        function renderAnalyticsChart(analyticsData) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analyticsData.labels,
                    datasets: [{
                        label: 'Correct Answers %',
                        data: analyticsData.correct_rates,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // Fetch and render practice history
        function fetchPracticeHistory() {
            fetch(`/api/user/practice_history/`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tableBody = document.getElementById('practiceHistoryTable');
                        tableBody.innerHTML = '';
                        data.history.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><a href="/practice/${item.set_id}/">${item.concept_area}</a></td>
                                <td>${item.practice_date}</td>
                                <td>${item.correct_rate}%</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        console.error('Failed to fetch practice history:', data.message);
                    }
                })
                .catch(error => console.error('Error fetching practice history:', error));
        }
    });
</script>
{% endblock %}